function enablestart(){var a=document.getElementById("startbutton");a.value="start",a.disabled=null,vid.play(),ctrack.start(vid),drawLoop()}function startVideo(){vid.play(),ctrack.start(vid),drawLoop()}function drawLoop(){requestAnimFrame(drawLoop),overlayCC.clearRect(0,0,400,300),ctrack.getCurrentPosition()&&ctrack.draw(overlay);var a=ctrack.getCurrentParameters(),b=ec.meanPredict(a);b&&updateData(b)}function runSuprisedTimer(){surprisedTimer=setTimeout(function(){console.log("Surprise detected..."),$surprisedPanel.fadeIn("slow"),surprisedTimerRunning=!1,clearTimeout(surprisedTimer),surprisedTimer=void 0},timerThreshold),surprisedTimerRunning=!0}function updateData(a){var d=(a[0].value,a[1].value,a[2].value);a[3].value;d>expressionAcceptanceThreshold?surprisedTimerRunning||runSuprisedTimer():(surprisedTimerRunning=!1,void 0!=surprisedTimer&&(clearTimeout(surprisedTimer),surprisedTimer=void 0));var f=svg.selectAll("rect").data(a).attr("y",function(a){return height-y(a.value)}).attr("height",function(a){return y(a.value)}),g=svg.selectAll("text.labels").data(a).attr("y",function(a){return height-y(a.value)}).text(function(a){return a.value.toFixed(1)});f.enter().append("svg:rect"),g.enter().append("svg:text"),f.exit().remove(),g.exit().remove()}var vid=document.getElementById("videoel"),overlay=document.getElementById("overlay"),overlayCC=overlay.getContext("2d");if(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.msURL||window.mozURL,navigator.getUserMedia){var videoSelector={video:!0};if(window.navigator.appVersion.match(/Chrome\/(.*?) /)){var chromeVersion=parseInt(window.navigator.appVersion.match(/Chrome\/(\d+)\./)[1],10);chromeVersion<20&&(videoSelector="video")}navigator.getUserMedia(videoSelector,function(a){vid.mozCaptureStream?vid.mozSrcObject=a:vid.src=window.URL&&window.URL.createObjectURL(a)||a,vid.play()},function(){alert("There was some problem trying to fetch video from your webcam. If you have a webcam, please make sure to accept when the browser asks for access to your webcam.")})}else alert("This demo depends on getUserMedia, which your browser does not seem to support. :(");vid.addEventListener("canplay",enablestart,!1);var ctrack=new clm.tracker({useWebGL:!0});ctrack.init(pModel);var ec=new emotionClassifier;ec.init(emotionModel);var emotionData=ec.getBlank(),margin={top:20,right:20,bottom:10,left:40},width=400-margin.left-margin.right,height=100-margin.top-margin.bottom,barWidth=30,formatPercent=d3.format(".0%"),x=d3.scale.linear().domain([0,ec.getEmotions().length]).range([margin.left,width+margin.left]),y=d3.scale.linear().domain([0,1]).range([0,height]),svg=d3.select("#emotion_chart").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom);svg.selectAll("rect").data(emotionData).enter().append("svg:rect").attr("x",function(a,b){return x(b)}).attr("y",function(a){return height-y(a.value)}).attr("height",function(a){return y(a.value)}).attr("width",barWidth).attr("fill","#2d578b"),svg.selectAll("text.labels").data(emotionData).enter().append("svg:text").attr("x",function(a,b){return x(b)+barWidth}).attr("y",function(a){return height-y(a.value)}).attr("dx",-barWidth/2).attr("dy","1.2em").attr("text-anchor","middle").text(function(a){return a.value}).attr("fill","white").attr("class","labels"),svg.selectAll("text.yAxis").data(emotionData).enter().append("svg:text").attr("x",function(a,b){return x(b)+barWidth}).attr("y",height+12).attr("dx",-barWidth/2).attr("text-anchor","middle").attr("style","font-size: 14").text(function(a){return a.emotion}).attr("transform","translate(0, 14)").attr("class","yAxis");var timerThreshold=800,expressionAcceptanceThreshold=.65,surprisedTimerRunning=!1,surprisedTimer,$closeIcons=$(".expression-panel .close");$allPanels=$(".expression-panel"),$surprisedPanel=$(".expression-panel.surprised"),$closeIcons.on("click",function(){$allPanels.fadeOut("slow")});var $container=$(".container");$("body").keypress(function(a){32==a.which&&$container.toggleClass("visible")});